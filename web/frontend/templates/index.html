{% extends "base.html" %}

{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div>
        <h1 class="title">Metricord Dashboard</h1>
        <p style="color: var(--text-secondary);">Statistiky serveru v reÃ¡lnÃ©m Äase</p>
    </div>

    <div style="display: flex; gap: 16px; align-items: center;">
        <div class="live-indicator">
            <span class="live-dot"></span>
            <span>LIVE</span>
        </div>

        <button id="editLayoutBtn" onclick="toggleEditMode()" class="btn"
            style="padding: 6px 12px; white-space: nowrap; display: flex; align-items: center; gap: 8px; background: var(--bg-card);">
            ğŸ–Šï¸ Upravit rozloÅ¾enÃ­
        </button>
        <button id="saveLayoutBtn" onclick="saveLayout()" class="btn"
            style="padding: 6px 12px; white-space: nowrap; display: none; align-items: center; gap: 8px; background: var(--success-gradient); color: white;">
            ğŸ’¾ UloÅ¾it
        </button>

        <form method="GET" action="/"
            style="display: flex; gap: 12px; align-items: center; background: var(--bg-card); padding: 8px 16px; border-radius: 12px; border: 1px solid var(--glass-border);">
            <div>
                <label
                    style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Role</label>
                <select name="role_id"
                    style="background: var(--bg-secondary); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 6px; border-radius: 6px; min-width: 120px;">
                    <option value="all" {% if selected_role=='all' %}selected{% endif %}>VÅ¡echny role</option>
                    {% for rid, rname in roles %}
                    <option value="{{ rid }}" {% if selected_role==rid %}selected{% endif %}>{{ rname }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Start
                    Date</label>
                <input type="date" name="start_date" value="{{ start_date|default('2025-12-21') }}"
                    style="background: var(--bg-secondary); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 6px; border-radius: 6px;">
            </div>
            <div>
                <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">End
                    Date</label>
                <input type="date" name="end_date" value="{{ end_date|default('2026-01-20') }}"
                    style="background: var(--bg-secondary); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 6px; border-radius: 6px;">
            </div>
            <button type="submit"
                style="height: 32px; padding: 0 16px; background: var(--primary-gradient); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; margin-top: 16px;">
                Filter
            </button>
        </form>
    </div>
</div>


<div id="hidden-drawer" class="hidden-drawer"
    style="display: none; margin-bottom: 30px; background: var(--bg-secondary); padding: 20px; border-radius: 16px; border: 2px dashed var(--glass-border);">
    <h3 style="margin-bottom: 15px; color: var(--text-secondary);">SkrytÃ© widgety (pÅ™etÃ¡hnÄ›te zpÄ›t pro zobrazenÃ­)</h3>
    <div id="hidden-widgets-grid" class="grid"
        style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; min-height: 100px;">

    </div>
</div>


{% macro render_widget(id) %}
{% if id == 'kpi_online' %}
<div class="card stat-card" data-id="kpi_online">
    <div class="stat-label">
        Online NynÃ­
        <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">PoÄet uÅ¾ivatelÅ¯
                online/active.</span></span>
    </div>
    <div class="stat-value" id="stat-online">{{ realtime_active }}</div>
    <div class="stat-diff diff-positive">V reÃ¡lnÃ©m Äase</div>
</div>
{% elif id == 'kpi_members' %}
<div class="card stat-card" data-id="kpi_members">
    <div class="stat-label">
        ÄŒlenÅ¯ celkem
        <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">CelkovÃ½ poÄet uÅ¾ivatelÅ¯.</span></span>
    </div>
    <div class="stat-value" id="stat-members">{{ total_members }}</div>
    <div class="stat-diff diff-neutral">Velikost serveru</div>
</div>
{% elif id == 'kpi_dau' %}
<div class="card stat-card" data-id="kpi_dau">
    <div class="stat-label">
        PrÅ¯mÄ›rnÃ© DAU
        <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">DennÄ› aktivnÃ­ uÅ¾ivatelÃ©.</span></span>
    </div>
    <div class="stat-value" id="stat-dau">{{ avg_dau }}</div>
    <div class="stat-diff diff-neutral">DennÄ› aktivnÃ­</div>
</div>
{% elif id == 'kpi_churn' %}
<div class="card stat-card" data-id="kpi_churn">
    <div class="stat-label">
        MÃ­ra odchodÅ¯
        <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Procento odchodÅ¯ za obdobÃ­.</span></span>
    </div>
    <div class="stat-value" id="stat-churn">{{ churn_rate }}%</div>
    <div class="stat-diff diff-negative">MÄ›sÃ­ÄnÃ­</div>
</div>
{% elif id == 'security_score' %}
<div class="card stat-card" data-id="security_score" id="security-score-card">
    <div class="stat-label">
        ğŸ  SkÃ³re komunity
        <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">CelkovÃ© hodnocenÃ­ zdravÃ­
                a aktivity komunity.</span></span>
    </div>
    <div style="display: flex; align-items: center; gap: 12px;">
        <div class="security-score-circle" style="width: 54px; height: 54px;">
            <svg class="progress-ring" width="54" height="54">
                <circle stroke="rgba(255,255,255,0.05)" stroke-width="4" fill="transparent" r="24" cx="27" cy="27" />
                <circle id="security-progress-ring" class="progress-ring-circle" stroke="var(--accent)" stroke-width="4"
                    stroke-linecap="round" fill="transparent" r="24" cx="27" cy="27"
                    style="stroke-dasharray: 150.8; stroke-dashoffset: 150.8;" />
            </svg>
            <div id="security-score-val" style="position: absolute; font-size: 18px; font-weight: 700;">--</div>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.4;">
            <div id="security-verdict" style="color: white; font-weight: 600;">NaÄÃ­tÃ¡nÃ­...</div>
            <div id="security-subtext">Analyzuji data...</div>
        </div>
    </div>
    <div id="security-insights"
        style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px; font-size: 12px; display: none;">
        <div
            style="font-weight: 600; margin-bottom: 6px; color: var(--text-tertiary); text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px;">
            PostÅ™ehy</div>
        <div id="insights-list"
            style="display: flex; flex-direction: column; gap: 8px; color: var(--text-secondary); max-height: 200px; overflow-y: auto; padding-right: 4px;">
        </div>
    </div>

    <div id="security-breakdown"
        style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #161625; border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px; margin-top: 8px; z-index: 10001; box-shadow: 0 12px 32px rgba(0,0,0,0.9); backdrop-filter: none;">
        <div style="font-weight: 700; margin-bottom: 12px; font-size: 0.95rem; color: white;">Rozklad skÃ³re</div>
        <div id="security-components" style="font-size: 0.85rem;"></div>
    </div>
</div>
{% elif id == 'chart_growth' %}
<div class="card" data-id="chart_growth" style="min-height: 350px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">ğŸ“ˆ RÅ¯st ÄlenÅ¯</h3>
        <div style="display: flex; gap: 10px;">
            <button class="chart-toggle active" data-chart="growth" data-type="total">Celkem</button>
            <button class="chart-toggle" data-chart="growth" data-type="joins">PÅ™Ã­rÅ¯stky</button>
        </div>
    </div>
    <div style="height: 300px;"><canvas id="memberGrowthChart"></canvas></div>
    <div id="growthEmpty"
        style="display: none; height: 100%; align-items: center; justify-content: center; top:0; position:absolute;">
        Brak danych</div>
</div>
{% elif id == 'chart_hourly' %}
<div class="card" data-id="chart_hourly" style="min-height: 350px;">
    <h3>â° HodinovÃ¡ aktivita</h3>
    <div style="height: 300px;"><canvas id="hourlyActivityChart"></canvas></div>
</div>
{% elif id == 'chart_stickiness' %}
<div class="card" data-id="chart_stickiness" style="min-height: 300px;">
    <h3>ğŸ§² Stickiness & Retention</h3>
    <div style="height: 250px;"><canvas id="stickinessChart"></canvas></div>
</div>
{% elif id == 'chart_msglen' %}
<div class="card" data-id="chart_msglen" style="min-height: 300px;">
    <h3>ğŸ“ DÃ©lka zprÃ¡v</h3>
    <div style="height: 250px;"><canvas id="msgLenChart"></canvas></div>
</div>
{% elif id == 'chart_weekly' %}
<div class="card" data-id="chart_weekly" style="min-height: 250px;">
    <h3>ğŸ“… TÃ½dennÃ­ aktivita</h3>
    <div style="height: 200px;"><canvas id="weeklyActivityChart"></canvas></div>
</div>
{% elif id == 'chart_heatmap' %}
<div class="card" data-id="chart_heatmap" style="min-height: 350px;">
    <h3>ğŸ”¥ Activity Heatmap</h3>
    <div style="display: flex; height: 300px; flex-direction: column;">
        <div
            style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-left: 40px; font-size: 0.8rem; color: var(--text-tertiary);">
            <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>23:00</span>
        </div>
        <div id="heatmap-container" style="display: grid; grid-template-rows: repeat(7, 1fr); gap: 4px; flex: 1;">

        </div>
    </div>
</div>
{% elif id == 'response_stats' %}
<div class="card" data-id="response_stats">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
        <div style="text-align:center;">
            <div class="stat-label">PrÅ¯mÄ›rnÃ¡ dÃ©lka</div>
            <div class="stat-value" style="font-size: 1.5rem;">{{ avg_msg_len }}</div>
        </div>
        <div style="text-align:center;">
            <div class="stat-label">NejaktivnÄ›jÅ¡Ã­ den</div>
            <div class="stat-value" style="font-size: 1.5rem;">{{ peak_day }}</div>
        </div>
        <div style="text-align:center;">
            <div class="stat-label">PodÃ­l odpovÄ›dÃ­</div>
            <div class="stat-value" style="font-size: 1.5rem;">{{ reply_ratio }}%</div>
        </div>
    </div>
</div>
{% endif %}
{% endmacro %}

{% set default_order = ['kpi_online', 'kpi_members', 'kpi_dau', 'kpi_churn', 'security_score', 'chart_growth',
'chart_hourly', 'chart_heatmap', 'chart_stickiness', 'chart_msglen', 'chart_weekly', 'response_stats'] %}
{% set active_order = widget_order if widget_order else default_order %}
{% set saved_spans = request.session.get('dashboard_spans', {}) %}
<div id="dashboard-grid" class="grid">
    {% for widget_id in active_order %}

    {% set default_span = 1 %}
    {% if widget_id in ['security_score', 'chart_growth', 'chart_hourly', 'chart_stickiness', 'chart_msglen',
    'chart_weekly', 'chart_heatmap'] %}{% set default_span = 2 %}{% endif %}
    {% set span_val = saved_spans.get(widget_id, default_span) %}

    <div class="widget-wrapper span-{{ span_val }}" data-id="{{ widget_id }}" data-span="{{ span_val }}"
        style="position: relative; display: flex; flex-direction: column;">




        <div class="resize-controls"
            style="display: none; position: absolute; top: 8px; right: 8px; z-index: 100; gap: 4px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
            <button class="resize-btn action-decrease" title="ZÃºÅ¾it (o sloupec doleva)"
                style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5" />
                </svg>
            </button>
            <button class="resize-btn action-increase" title="RozÅ¡Ã­Å™it (o sloupec doprava)"
                style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 17l5-5-5-5M6 17l5-5-5-5" />
                </svg>
            </button>
        </div>



        <style>
            .widget-wrapper .card {
                height: 100% !important;
                margin: 0 !important;
            }
        </style>
        {{ render_widget(widget_id) }}
    </div>
    {% endfor %}
</div>


<div style="display:none;">
    <div id="hidden-bucket">
        {% for widget_id in hidden_widgets %}

        {% set default_span = 1 %}
        {% if widget_id in ['security_score', 'chart_growth', 'chart_hourly', 'chart_stickiness', 'chart_msglen',
        'chart_weekly', 'chart_heatmap'] %}{% set default_span = 2 %}{% endif %}
        {% set span_val = saved_spans.get(widget_id, default_span) %}

        <div class="widget-wrapper span-{{ span_val }}" data-id="{{ widget_id }}" data-span="{{ span_val }}"
            style="position: relative; display: flex; flex-direction: column;">


            <div class="resize-controls"
                style="display: none; position: absolute; top: 8px; right: 8px; z-index: 100; gap: 4px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                <button class="resize-btn action-decrease" title="ZÃºÅ¾it"
                    style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5" />
                    </svg>
                </button>
                <button class="resize-btn action-increase" title="RozÅ¡Ã­Å™it"
                    style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 17l5-5-5-5M6 17l5-5-5-5" />
                    </svg>
                </button>
            </div>


            <style>
                .widget-wrapper .card {
                    height: 100% !important;
                    margin: 0 !important;
                }
            </style>
            {{ render_widget(widget_id) }}
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .widget-wrapper {
        transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .widget-wrapper.resizing {
        z-index: 100 !important;
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.4);
    }

    #security-score-card:hover {
        z-index: 9999 !important;
    }

    #security-score-card:hover #security-breakdown {
        display: block !important;
    }

    .sortable-ghost {
        opacity: 0.4;
        background: var(--bg-tertiary);
        border: 2px dashed var(--primary);
    }

    .draggable-mode .card {
        cursor: grab;
        border: 2px dashed rgba(255, 255, 255, 0.1);
    }

    .draggable-mode .card:hover {
        border-color: var(--primary);
    }

    .security-score-circle {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.8s ease;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    // --- Sortable / Drag-and-Drop Implementation ---
    let sortableMain = null;
    let sortableHidden = null;
    const grid = document.getElementById('dashboard-grid');
    const drawer = document.getElementById('hidden-drawer');
    const hiddenGrid = document.getElementById('hidden-widgets-grid');
    const editBtn = document.getElementById('editLayoutBtn');
    const saveBtn = document.getElementById('saveLayoutBtn');

    // Move hidden widgets to drawer on load
    document.addEventListener('DOMContentLoaded', () => {
        const bucket = document.getElementById('hidden-bucket');
        while (bucket.children.length > 0) {
            hiddenGrid.appendChild(bucket.children[0]);
        }
    });

    function toggleEditMode() {
        if (sortableMain) {
            // Cancel/Exit
            sortableMain.destroy();
            sortableHidden.destroy();
            sortableMain = null;
            sortableHidden = null;

            editBtn.innerHTML = 'ğŸ–Šï¸ Upravit rozloÅ¾enÃ­';
            editBtn.classList.remove('btn-active');
            editBtn.style.background = '';
            saveBtn.style.display = 'none';
            drawer.style.display = 'none';
            grid.classList.remove('draggable-mode');
            hiddenGrid.classList.remove('draggable-mode');

            // Hide Controls explicitly
            document.querySelectorAll('.resize-controls').forEach(el => el.style.display = 'none');

            window.location.reload();
        } else {
            // Enable
            drawer.style.display = 'block';
            grid.classList.add('draggable-mode');
            hiddenGrid.classList.add('draggable-mode');

            // Show Controls explicitly
            document.querySelectorAll('.resize-controls').forEach(el => el.style.display = 'flex');

            sortableMain = new Sortable(grid, {
                group: 'dashboard',
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.card'
            });

            sortableHidden = new Sortable(hiddenGrid, {
                group: 'dashboard',
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.card'
            });

            editBtn.innerHTML = 'âŒ ZruÅ¡it';
            editBtn.style.background = 'var(--bg-tertiary)';
            saveBtn.style.display = 'flex';
        }
    }

    // --- Robust Resize Logic (Capture Phase Delegation) ---
    // Handle mousedown/touchstart FIRST to block Sortable
    grid.addEventListener('mousedown', (e) => {
        if (e.target.closest('.resize-controls')) {
            e.stopPropagation(); // Stop Sortable from seeing this event
        }
    }, { capture: true });

    grid.addEventListener('touchstart', (e) => {
        if (e.target.closest('.resize-controls')) {
            e.stopPropagation();
        }
    }, { capture: true });

    // Handle Clicks
    grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.resize-btn');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const wrapper = btn.closest('.widget-wrapper');
        const isIncrease = btn.classList.contains('action-increase');
        const delta = isIncrease ? 1 : -1;

        if (wrapper) {
            let currentSpan = parseInt(wrapper.dataset.span || 1);
            let newSpan = Math.max(1, Math.min(4, currentSpan + delta));

            // Update Class and Data
            wrapper.classList.remove('span-1', 'span-2', 'span-3', 'span-4');
            wrapper.classList.add(`span-${newSpan}`);
            wrapper.dataset.span = newSpan;

            // Direct CSS Injection Fallback
            wrapper.style.gridColumn = `span ${newSpan}`;

            // Visual Feedback
            wrapper.style.transform = 'scale(1.02)';
            wrapper.style.boxShadow = '0 0 20px var(--accent)';
            setTimeout(() => {
                wrapper.style.transform = '';
                wrapper.style.boxShadow = '';
            }, 200);
        }
    });

    async function saveLayout() {
        if (!sortableMain) return;
        // Sortable works on the grid children (wrappers now)
        const wrappers = document.querySelectorAll('#dashboard-grid .widget-wrapper');
        const visibleOrder = [];
        const spans = {};

        wrappers.forEach(w => {
            const id = w.dataset.id;
            visibleOrder.push(id);
            spans[id] = parseInt(w.dataset.span || 1);
        });

        const formData = new FormData();
        formData.append('widget_order', JSON.stringify(visibleOrder));
        formData.append('widget_spans', JSON.stringify(spans));
        formData.append('page', 'overview');

        try {
            const resp = await fetch('/settings/dashboard', {
                method: 'POST',
                body: formData
            });
            if (resp.ok) {
                window.location.reload();
            } else {
                alert('Chyba pÅ™i uklÃ¡dÃ¡nÃ­ rozloÅ¾enÃ­');
            }
        } catch (e) {
            console.error(e);
            alert('Chyba spojenÃ­');
        }
    }
</script>

<script>
    // Load Security Score
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            const resp = await fetch('/api/security-score');
            const data = await resp.json();

            if (data.overall_score !== undefined) {
                const score = data.overall_score;
                const ring = document.getElementById('security-progress-ring');
                const valueEl = document.getElementById('security-score-val');
                const ratingEl = document.getElementById('security-verdict');
                const detailEl = document.getElementById('security-subtext');
                const componentsEl = document.getElementById('security-components');

                if (ring) {
                    const circumference = 2 * Math.PI * 24;
                    const offset = circumference - (score / 100) * circumference;
                    ring.style.strokeDasharray = `${circumference} ${circumference}`;
                    ring.style.strokeDashoffset = offset;
                    ring.style.stroke = data.rating_color || '#6B7280';
                }
                if (valueEl) {
                    valueEl.textContent = score;
                    valueEl.style.color = data.rating_color;
                }
                if (ratingEl) {
                    ratingEl.textContent = data.rating || 'NeznÃ¡mÃ½';
                    ratingEl.style.color = data.rating_color;
                }
                if (detailEl) {
                    detailEl.textContent = 'NajetÃ­m zobrazÃ­te detaily';
                    detailEl.style.color = 'var(--text-tertiary)';
                }

                // Breakdown logic
                if (data.components && componentsEl) {
                    let html = '';
                    for (const [key, comp] of Object.entries(data.components)) {
                        const barColor = comp.score >= 70 ? '#10B981' : comp.score >= 40 ? '#F59E0B' : '#EF4444';
                        html += `<div style="margin-bottom:8px;"><div style="display:flex;justify-content:space-between;"><span>${comp.label}</span><span style="color:${barColor}">${comp.score}</span></div></div>`;
                    }
                    componentsEl.innerHTML = html;
                }

                // Insights logic
                const insightsCont = document.getElementById('security-insights');
                const insightsList = document.getElementById('insights-list');
                if (data.insights && data.insights.length > 0 && insightsCont && insightsList) {
                    insightsCont.style.display = 'block';
                    insightsList.innerHTML = data.insights.map(txt => {
                        const formatted = txt.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                        return `<div style="display:flex;gap:8px;align-items:flex-start;line-height:1.4;">
                            <span style="flex:1;">${formatted}</span>
                        </div>`;
                    }).join('');
                } else if (insightsCont) {
                    insightsCont.style.display = 'none';
                }
            }
        } catch (e) {
            console.error(e);
            const detailEl = document.getElementById('security-subtext');
            if (detailEl) detailEl.textContent = 'Err: ' + e.message;
        }
    });
</script>

<script>
    const chartData = {
        dau: {
            labels: {{ dau_labels | tojson | safe }},
    data: {{ dau_data | tojson | safe }}
        },
    growth: {
        labels: {{ labels | tojson | safe }},
        joins: {{ joins_data | tojson | safe }},
        leaves: {{ leaves_data | tojson | safe }},
        total: {{ total_data | default ([]) | tojson | safe }}
    },
    hourly: {
        labels: {{ hourly_labels | tojson | safe }},
        data: {{ hourly_activity | tojson | safe }}
    },
    stickiness: {
        labels: {{ retention_labels | tojson | safe }},
        dauMau: {{ dau_mau_ratio | tojson | safe }},
        dauWau: {{ dau_wau_ratio | tojson | safe }}
    },
    msglen: {
        labels: {{ msglen_labels | tojson | safe }},
        data: {{ msglen_data | tojson | safe }}
    },
    weekly: {
        labels: {{ weekly_labels | tojson | safe }},
        data: {{ weekly_data | tojson | safe }}
    }
    };

    document.addEventListener('DOMContentLoaded', function () {
        try {
            // -- Chart References --
            let memberChart = null;

            // -- Chart Logic --
            if (chartData.dau.data && document.getElementById('dauChart')) {
                ChartUtils.createLineChart('dauChart', chartData.dau.labels, chartData.dau.data, 'DAU', '#8b5cf6', '#ec4899');
            }
            if (chartData.growth.joins && document.getElementById('memberGrowthChart')) {
                const ctx = document.getElementById('memberGrowthChart');

                // Initialize with 'total' if specified or default to 'joins'
                // The HTML buttons default to 'total' as active usually, let's check class

                const createGrowthChart = (type) => {
                    if (memberChart) memberChart.destroy();

                    if (type === 'total') {
                        memberChart = ChartUtils.createLineChart('memberGrowthChart', chartData.growth.labels, chartData.growth.total, 'Celkem ÄlenÅ¯', '#3b82f6', '#06b6d4');
                    } else {
                        memberChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: chartData.growth.labels,
                                datasets: [
                                    { label: 'PÅ™Ã­rÅ¯stky', data: chartData.growth.joins, backgroundColor: '#10b981', borderRadius: 4 },
                                    { label: 'Odchody', data: chartData.growth.leaves, backgroundColor: '#ef4444', borderRadius: 4 }
                                ]
                            },
                            options: {
                                ...ChartUtils.premiumChartOptions,
                                scales: { x: { stacked: true }, y: { stacked: true }}
                            }
                        });
                    }
                };

                // Default view
                createGrowthChart('total');

                // Button Handlers
                document.querySelectorAll('.chart-toggle[data-chart="growth"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Switch active class
                        document.querySelectorAll('.chart-toggle[data-chart="growth"]').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');

                        const type = e.target.dataset.type;
                        createGrowthChart(type);
                    });
                });
            }
            if (chartData.hourly.data && document.getElementById('hourlyActivityChart')) {
                ChartUtils.createBarChart('hourlyActivityChart', chartData.hourly.labels, chartData.hourly.data, 'Msgs', '#f59e0b', '#fbbf24');
            }
            if (chartData.stickiness.dauMau && document.getElementById('stickinessChart')) {
                ChartUtils.createMultiChart('stickinessChart', chartData.stickiness.labels, [
                    { label: 'DAU/MAU', data: chartData.stickiness.dauMau },
                    { label: 'DAU/WAU', data: chartData.stickiness.dauWau }
                ]);
            }
            if (chartData.msglen.data && document.getElementById('msgLenChart')) {
                new Chart(document.getElementById('msgLenChart'), {
                    type: 'doughnut',
                    data: { labels: chartData.msglen.labels, datasets: [{ data: chartData.msglen.data, backgroundColor: ['#8b5cf6', '#6366f1', '#4f46e5', '#ec4899', '#f472b6'] }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            if (chartData.weekly.data && document.getElementById('weeklyActivityChart')) {
                new Chart(document.getElementById('weeklyActivityChart'), {
                    type: 'radar',
                    data: { labels: chartData.weekly.labels, datasets: [{ label: 'Activity', data: chartData.weekly.data, backgroundColor: 'rgba(139, 92, 246, 0.2)', borderColor: '#8b5cf6' }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                ticks: { showLabelBackdrop: false, color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                pointLabels: { color: '#9ca3af' }
                            }
                        }
                    }
                });
            }

            // Heatmap Rendering
            const heatmapData = {{ redis_stats.heatmap_data | default ([]) | tojson | safe
        }};
    const heatmapContainer = document.getElementById('heatmap-container');
    if (heatmapData.length > 0 && heatmapContainer) {
        const days = ["Po", "Ãšt", "St", "ÄŒt", "PÃ¡", "So", "Ne"];
        const maxVal = {{ redis_stats.heatmap_max | default (1)
    }};

    heatmapData.forEach((dayData, dayIdx) => {
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '40px repeat(24, 1fr)';
        row.style.gap = '4px';
        row.style.alignItems = 'center';

        // Day Label
        const label = document.createElement('div');
        label.textContent = days[dayIdx];
        label.style.fontSize = '0.7rem';
        label.style.color = 'var(--text-secondary)';
        row.appendChild(label);

        // Hour Cells
        dayData.forEach(val => {
            const cell = document.createElement('div');
            cell.style.borderRadius = '2px';
            cell.style.height = '100%';

            // Color intensity
            const intensity = val > 0 ? (val / maxVal) : 0;
            const alpha = Math.max(0.1, intensity); // Min opacity for visible cells if > 0

            if (val === 0) {
                cell.style.background = 'rgba(255,255,255,0.03)';
            } else {
                cell.style.background = `rgba(139, 92, 246, ${alpha})`; // Primary color
                cell.title = `Msg: ${val}`;
                // Tooltip can be enhanced later
            }
            row.appendChild(cell);
        });
        heatmapContainer.appendChild(row);
    });
            }

    // Animate stats
    const valOnline = {{ realtime_active | default (0) | tojson | safe }};
    const valMembers = {{ total_members | default (0) | tojson | safe }};
    const valDau = {{ avg_dau | default (0) | tojson | safe }};
    const valChurn = {{ churn_rate | default (0) | tojson | safe }};

    const stats = [
        { id: 'stat-online', value: valOnline },
        { id: 'stat-members', value: valMembers },
        { id: 'stat-dau', value: valDau },
        { id: 'stat-churn', value: valChurn }
    ];
    stats.forEach(s => {
        const el = document.getElementById(s.id);
        if (el) el.innerText = s.value;
    });

        } catch (e) { console.error(e); }
    });
</script>
{% endblock %}