{% extends "base.html" %}

{% block content %}
{% set layout = request.session.get('dashboard_layout', {}) %}
{% macro is_visible(key) %}{{ layout.get(key, True) }}{% endmacro %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
    <div>
        <h1 class="title">Advanced Analytics</h1>
        <p style="color: var(--text-secondary);">Channel stats, leaderboards, and insights</p>
    </div>

    <form method="GET"
        style="display: flex; gap: 12px; align-items: center; background: var(--bg-card); padding: 8px 16px; border-radius: 12px; border: 1px solid var(--glass-border);">
        <div style="display: flex; flex-direction: column; gap: 4px;">
            <label
                style="font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Role</label>
            <select name="role_id" id="roleFilter" style="min-width: 140px;">
                <option value="all" {% if selected_role=='all' %}selected{% endif %}>V≈°echny role</option>
                {% for rid, rname in roles %}
                <option value="{{ rid }}" {% if selected_role==rid %}selected{% endif %}>{{ rname }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="display: flex; flex-direction: column; gap: 4px;">
            <label
                style="font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Od</label>
            <input type="date" name="start_date" id="startDate" value="{{ start_date|default('2025-12-21') }}">
        </div>
        <div style="display: flex; flex-direction: column; gap: 4px;">
            <label
                style="font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Do</label>
            <input type="date" name="end_date" id="endDate" value="{{ end_date|default('2026-01-20') }}">
        </div>
        <button type="submit" class="btn"
            style="height: 42px; margin-top: auto; display: flex; align-items: center; gap: 8px;">
            <span>Filtrovat</span>
        </button>
    </form>
</div>


{% if layout.get('show_comparisons', True) %}
<div class="grid" style="grid-template-columns: 1fr 1fr;">
    <div class="card">
        <h3 style="margin-bottom: 12px;">
            üìà Week-over-Week
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Srovn√°n√≠ aktivity denn√≠ch u≈æivatel≈Ø
                    (DAU) tento
                    t√Ωden oproti minul√©mu.</span></span>
        </h3>
        <div class="stat-value" id="wow-value">Loading...</div>
        <div class="stat-diff" id="wow-change">Calculating...</div>
    </div>
    <div class="card">
        <h3 style="margin-bottom: 12px;">
            üìä Month-over-Month
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Srovn√°n√≠ pr≈Ømƒõrn√© denn√≠ aktivity
                    tento mƒõs√≠c
                    oproti minul√©mu.</span></span>
        </h3>
        <div class="stat-value" id="mom-value">Loading...</div>
        <div class="stat-diff" id="mom-change">Calculating...</div>
    </div>
</div>
{% endif %}


<div class="grid" style="grid-template-columns: 1fr 1fr; margin-top: 32px;">
    
    {% if layout.get('show_top_channels', True) %}
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            üèÜ Top Channels
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Nejaktivnƒõj≈°√≠ kan√°ly podle poƒçtu
                    zpr√°v ve
                    zvolen√©m obdob√≠.</span></span>
        </h3>
        <div class="chart-container" style="position: relative;">
            <div id="channelChartLoader"
                style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: var(--bg-card); z-index: 10;">
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <p style="color: var(--text-secondary); margin-top: 12px;">Naƒç√≠t√°m data kan√°l≈Ø...</p>
                </div>
            </div>
            <div id="channelChartEmpty"
                style="position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-card); z-index: 5;">
                <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                <h4 style="margin-bottom: 8px;">≈Ω√°dn√° data kan√°l≈Ø</h4>
                <p style="color: var(--text-secondary); font-size: 14px; text-align: center; max-width: 80%;">
                    {% if has_any_data %}
                    Pro toto obdob√≠ nebyla nalezena ≈æ√°dn√° aktivita v kan√°lech.
                    {% else %}
                    Pro tento server zat√≠m nejsou k dispozici ≈æ√°dn√° data.
                    <br>Spus≈•te <strong>Backfill</strong> v Nastaven√≠.
                    {% endif %}
                </p>
                {% if not has_any_data %}
                <a href="/settings" class="btn btn-sm btn-primary" style="margin-top: 16px;">P≈ôej√≠t do Nastaven√≠</a>
                {% endif %}
            </div>
            <canvas id="channelChart"></canvas>
        </div>
    </div>
    {% endif %}

    
    {% if layout.get('show_leaderboard', True) %}
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            üëë Nejaktivnƒõj≈°√≠ u≈æivatel√©
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">≈Ωeb≈ô√≠ƒçek u≈æivatel≈Ø s nejvy≈°≈°√≠m poƒçtem
                    zpr√°v a
                    jejich pr≈Ømƒõrnou d√©lkou.</span></span>
        </h3>
        <div id="leaderboard-container" style="max-height: 400px; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>U≈æivatel</th>
                        <th style="text-align: right;">Zpr√°vy</th>
                        <th style="text-align: right;">Pr≈Øm. d√©lka</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-tbody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>


{% if layout.get('show_peak_analysis', True) %}
<div class="card" style="margin-top: 32px;">
    <h3 style="margin-bottom: 20px;">
        üî• Anal√Ωza ≈°piƒçky (Peak Activity)
        <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Anal√Ωza ƒças≈Ø a dn≈Ø s nejvy≈°≈°√≠ aktivitou
                na
                serveru.</span></span>
    </h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div>
            <div style="color: var(--text-secondary); margin-bottom: 8px;">Nejru≈°nƒõj≈°√≠ hodina</div>
            <div class="stat-value" style="font-size: 2rem;" id="peak-hour">--</div>
        </div>
        <div>
            <div style="color: var(--text-secondary); margin-bottom: 8px;">Nejru≈°nƒõj≈°√≠ den</div>
            <div class="stat-value" style="font-size: 2rem;" id="peak-day">--</div>
        </div>
        <div>
            <div style="color: var(--text-secondary); margin-bottom: 8px;">Zpr√°vy ve ≈°piƒçce</div>
            <div class="stat-value" style="font-size: 2rem;" id="peak-messages">--</div>
        </div>
        <div>
            <div style="color: var(--text-secondary); margin-bottom: 8px;">Nejklidnƒõj≈°√≠ obdob√≠</div>
            <div class="stat-value" style="font-size: 2rem;" id="quiet-period">--</div>
        </div>
    </div>
</div>
{% endif %}


<div class="grid" style="grid-template-columns: 1fr 1fr; margin-top: 32px; gap: 24px;">

    
    {% if layout.get('show_channel_dist', True) %}
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            üì¢ Rozlo≈æen√≠ aktivity (Kan√°ly)
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Procentu√°ln√≠ rozdƒõlen√≠ zpr√°v mezi
                    jednotliv√©
                    kan√°ly.</span></span>
        </h3>
        <div class="chart-container" style="position: relative; height: 300px;">
            <canvas id="channelDistChart"></canvas>
        </div>
    </div>
    {% endif %}

    
    {% if layout.get('show_commands', True) %}
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            ü§ñ Nejpou≈æ√≠vanƒõj≈°√≠ p≈ôikazy
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Statistika nejpou≈æ√≠vanƒõj≈°√≠ch p≈ô√≠kaz≈Ø
                    bota.</span></span>
        </h3>
        <div class="chart-container" style="position: relative; height: 300px;">
            <canvas id="commandChart"></canvas>
        </div>
    </div>
    {% endif %}

    
    {% if layout.get('show_voice', True) %}
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            üéôÔ∏è Voice Leaderboard (Top 10)
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">U≈æivatel√©, kte≈ô√≠ str√°vili nejv√≠ce
                    ƒçasu ve voice
                    kan√°lech.</span></span>
        </h3>
        <div style="overflow-y: auto; max-height: 300px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--glass-border);">
                        <th style="text-align: left; padding: 8px; color: var(--text-secondary);">U≈æivatel</th>
                        <th style="text-align: right; padding: 8px; color: var(--text-secondary);">ƒåas (h:m)</th>
                    </tr>
                </thead>
                <tbody id="voice-tbody">
                    <tr>
                        <td colspan="2" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Naƒç√≠t√°m...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    
    {% if layout.get('show_traffic', True) %}
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            üö¶ Traffic (P≈ô√≠chody vs Odchody)
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Srovn√°n√≠ poƒçtu nov√Ωch u≈æivatel≈Ø a
                    odchod≈Ø v
                    ƒçase.</span></span>
        </h3>
        <div class="chart-container" style="position: relative; height: 300px;">
            <canvas id="trafficChart"></canvas>
        </div>
    </div>
    {% endif %}

</div>


{% if layout.get('show_tools', True) %}
<div class="grid" style="grid-template-columns: 1fr 1fr; margin-top: 32px;">
    
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            üìà Trend Anal√Ωza
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">V√Ωpoƒçet r≈Østu a p≈ôedpovƒõƒè budouc√≠
                    aktivity na
                    z√°kladƒõ historick√Ωch dat.</span></span>
        </h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">R≈Øst za 7 dn√≠</div>
                <div id="trend-7d" style="font-size: 1.5rem; font-weight: 700;">--</div>
            </div>
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">R≈Øst za 30 dn√≠</div>
                <div id="trend-30d" style="font-size: 1.5rem; font-weight: 700;">--</div>
            </div>
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Pr≈Ømƒõr DAU</div>
                <div id="trend-avg-dau" style="font-size: 1.5rem; font-weight: 700;">--</div>
            </div>
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Predikce</div>
                <div id="trend-prediction" style="font-size: 1.5rem; font-weight: 700;">--</div>
            </div>
        </div>
    </div>

    
    <div class="card">
        <h3 style="margin-bottom: 16px;">
            üéØ Index Zapojen√≠
            <span class="info-icon dash-tooltip">? <span class="dash-tooltip-text">Komplexn√≠ sk√≥re aktivity zalo≈æen√© na
                    zpr√°v√°ch,
                    voice ƒçase a retenci.</span></span>
        </h3>
        <div style="display: flex; align-items: center; gap: 24px;">
            <div
                style="position: relative; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; background: conic-gradient(#8b5cf6 0deg, #8b5cf6 var(--engagement-deg, 0deg), var(--bg-tertiary) var(--engagement-deg, 0deg)); border-radius: 50%;">
                <div
                    style="width: 70px; height: 70px; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 1.5rem; font-weight: 700;" id="engagement-score">--</span>
                </div>
            </div>
            <div style="flex: 1;">
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: var(--text-secondary);">Aktivita zpr√°v</div>
                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; margin-top: 4px;">
                        <div id="msg-activity-bar"
                            style="height: 100%; width: 0%; background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 4px; transition: width 1s;">
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: var(--text-secondary);">Voice aktivita</div>
                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; margin-top: 4px;">
                        <div id="voice-activity-bar"
                            style="height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #34d399); border-radius: 4px; transition: width 1s;">
                        </div>
                    </div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Retence</div>
                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; margin-top: 4px;">
                        <div id="retention-bar"
                            style="height: 100%; width: 0%; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 4px; transition: width 1s;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="grid" style="grid-template-columns: 1fr 1fr; margin-top: 32px;">
    
    <div class="card">
        <h3 style="margin-bottom: 16px;">üì§ Export Dat</h3>
        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
            St√°hnƒõte statistiky serveru ve form√°tu CSV pro dal≈°√≠ anal√Ωzu.
        </p>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button onclick="exportData('leaderboard')" class="btn"
                style="background: var(--bg-tertiary); border: 1px solid var(--glass-border);">
                üë• Leaderboard
            </button>
            <button onclick="exportData('channels')" class="btn"
                style="background: var(--bg-tertiary); border: 1px solid var(--glass-border);">
                üìä Kan√°ly
            </button>
            <button onclick="exportData('activity')" class="btn"
                style="background: var(--bg-tertiary); border: 1px solid var(--glass-border);">
                üìà Aktivita
            </button>
        </div>
    </div>

    
    <div class="card">
        <h3 style="margin-bottom: 16px;">üí° Post≈ôehy</h3>
        <div id="insights-container" style="font-size: 14px;">
            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; color: var(--text-secondary);"
                id="insight-1">
                ‚è≥ Naƒç√≠t√°m anal√Ωzy...
            </div>
            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; display: none;"
                id="insight-2">
            </div>
            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: none;"
                id="insight-3">
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="/static/js/charts.js?v=2"></script>

<script>
    // Unified loader helper to pass all filters
    function getFilterParams() {
        const urlParams = new URLSearchParams(window.location.search);
        // Fallback to form values if URL is clean
        if (!urlParams.has('start_date')) {
            const sd = document.getElementById('startDate').value;
            const ed = document.getElementById('endDate').value;
            const rid = document.getElementById('roleFilter').value;
            if (sd) urlParams.set('start_date', sd);
            if (ed) urlParams.set('end_date', ed);
            if (rid) urlParams.set('role_id', rid);
        }
        return urlParams.toString();
    }

    // Load comparisons
    async function loadComparisons() {
        try {
            const resp = await fetch(`/api/comparisons?${getFilterParams()}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            if (data.error) throw new Error(data.error);

            if (!data.week_over_week || !data.month_over_month) {
                document.getElementById('wow-value').innerHTML = '<span style="color:orange; font-size:12px">Partial Data</span>';
                document.getElementById('mom-value').innerHTML = '<span style="color:orange; font-size:12px">Partial Data</span>';
                return;
            }

            // WoW
            const wowVal = document.getElementById('wow-value');
            if (wowVal) wowVal.textContent = `${data.week_over_week.this_week} DAU`;
            const wowChange = document.getElementById('wow-change');
            if (wowChange) {
                const wowPercent = data.week_over_week.change_percent;
                wowChange.textContent = `${wowPercent > 0 ? '+' : ''}${wowPercent}% vs last week`;
                wowChange.className = `stat-diff ${wowPercent > 0 ? 'diff-positive' : 'diff-negative'}`;
            }

            // MoM
            const momVal = document.getElementById('mom-value');
            if (momVal) momVal.textContent = `${data.month_over_month.this_month} DAU`;
            const momChange = document.getElementById('mom-change');
            if (momChange) {
                const momPercent = data.month_over_month.change_percent;
                momChange.textContent = `${momPercent > 0 ? '+' : ''}${momPercent}% vs last month`;
                momChange.className = `stat-diff ${momPercent > 0 ? 'diff-positive' : 'diff-negative'}`;
            }
        } catch (e) {
            console.error('Error loading comparisons:', e);
            const w = document.getElementById('wow-value');
            const m = document.getElementById('mom-value');
            if (w) w.innerHTML = `<span style="color:red; font-size:10px">${e.message}</span>`;
            if (m) m.innerHTML = `<span style="color:red; font-size:10px">${e.message}</span>`;
        }
    }

    // Load channel stats
    async function loadChannelStats() {
        const loader = document.getElementById('channelChartLoader');
        const empty = document.getElementById('channelChartEmpty');
        try {
            console.log('Fetching channel stats with params:', getFilterParams());
            const resp = await fetch(`/api/channel-stats?${getFilterParams()}`);
            const data = await resp.json();

            if (loader) loader.style.display = 'none';

            if (!data.channels || data.channels.length === 0) {
                if (empty) empty.style.display = 'flex';
                return;
            }
            if (empty) empty.style.display = 'none';

            const labels = data.channels.map(c => c.name || `#${c.channel_id}`);
            const values = data.channels.map(c => parseInt(c.count) || 0);

            const canvas = document.getElementById('channelChart');
            if (!canvas) return; // Guard against missing element
            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            const existingChart = Chart.getChart(canvas);
            if (existingChart) existingChart.destroy();

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Messages',
                        data: values,
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    ...ChartUtils.premiumChartOptions,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { precision: 0 }
                        },
                        y: { grid: { display: false }}
                    }
                }
            });
        } catch (e) {
            console.error('Error loading channel stats:', e);
            if (empty) {
                empty.style.display = 'flex';
                empty.querySelector('h4').textContent = 'Chyba naƒç√≠t√°n√≠';
                empty.querySelector('p').innerHTML = `<span style="color:red">${e.message}</span>`;
            }
            if (loader) loader.style.display = 'none';
        }
    }

    // Load Channel Distribution (Doughnut)
    async function loadChannelDist() {
        try {
            const resp = await fetch(`/api/channel-stats?${getFilterParams()}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            if (!data.channels || data.channels.length === 0) return;

            // Take top 5 for doughnut
            const topChannels = data.channels.slice(0, 5);
            const labels = topChannels.map(c => c.name || `#${c.channel_id}`);
            const values = topChannels.map(c => parseInt(c.count) || 0);

            if (document.getElementById('channelDistChart')) {
                ChartUtils.createDoughnutChart('channelDistChart', labels, values);
            }
        } catch (e) { console.error('Error loading channel dist:', e); }
    }

    // Load leaderboard
    async function loadLeaderboard() {
        try {
            const resp = await fetch(`/api/leaderboard?limit=10&${getFilterParams()}`);
            const data = await resp.json();
            const tbody = document.getElementById('leaderboard-tbody');
            if (!tbody) return;

            if (!data.leaderboard || data.leaderboard.length === 0) {
                console.log('No leaderboard entries found.');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">≈Ω√°dn√° data.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            data.leaderboard.forEach((user, i) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const displayName = user.name || `U≈æivatel ${user.user_id}`;
                tbody.innerHTML += `
                <tr>
                    <td style="padding: 16px;">${i < 3 ? medals[i] : i + 1}</td>
                    <td style="padding: 16px;">${displayName}</td>
                    <td style="padding: 16px; text-align: right; font-weight: 600;">${(user.total_messages || 0).toLocaleString()}</td>
                    <td style="padding: 16px; text-align: right;">${user.avg_message_length || 0} ch</td>
                </tr>`;
            });
        } catch (e) { console.error('Leaderboard error:', e); }
    }

    async function loadPeakAnalysis() {
        try {
            const val = document.getElementById('peak-hour');
            if (!val) return; // Check if element exists

            const resp = await fetch(`/api/peak-stats?${getFilterParams()}`);
            const data = await resp.json();
            document.getElementById('peak-hour').textContent = data.peak_hour || '--';
            document.getElementById('peak-day').textContent = data.peak_day || '--';
            document.getElementById('peak-messages').textContent = data.peak_messages || '--';
            document.getElementById('quiet-period').textContent = data.quiet_period || '--';
        } catch (e) { }
    }

    async function loadAnalyticsTools() {
        try {
            if (!document.getElementById('trend-7d')) return;

            const resp = await fetch(`/api/analytics-tools?${getFilterParams()}`);
            const data = await resp.json();
            if (data.status === 'ok') {
                document.getElementById('trend-7d').textContent = (data.trends.growth_7d > 0 ? '+' : '') + data.trends.growth_7d + '%';
                document.getElementById('trend-30d').textContent = (data.trends.growth_30d > 0 ? '+' : '') + data.trends.growth_30d + '%';
                document.getElementById('trend-avg-dau').textContent = data.trends.avg_dau;
                document.getElementById('trend-prediction').textContent = '~' + data.trends.prediction;
                document.getElementById('engagement-score').textContent = data.engagement.score;
                document.documentElement.style.setProperty('--engagement-deg', (data.engagement.score * 3.6) + 'deg');

                if (document.getElementById('msg-activity-bar')) document.getElementById('msg-activity-bar').style.width = data.engagement.msg_activity + '%';
                if (document.getElementById('voice-activity-bar')) document.getElementById('voice-activity-bar').style.width = data.engagement.voice_activity + '%';
                if (document.getElementById('retention-bar')) document.getElementById('retention-bar').style.width = data.engagement.retention + '%';

                const container = document.getElementById('insights-container');
                if (container) {
                    container.innerHTML = '';
                    (data.insights.length ? data.insights : [{ text: 'Zat√≠m ≈æ√°dn√© post≈ôehy.' }]).forEach(insight => {
                        const div = document.createElement('div');
                        div.className = 'insight-item';
                        div.style.padding = '10px'; div.style.marginBottom = '5px'; div.style.background = 'rgba(255,255,255,0.03)';
                        div.style.borderLeft = `4px solid ${insight.type === 'positive' ? '#10b981' : (insight.type === 'negative' ? '#ef4444' : '#8b5cf6')}`;
                        div.textContent = insight.text;
                        container.appendChild(div);
                    });
                }
            }
        } catch (e) { }
    }

    async function loadTrafficStats() {
        if (!document.getElementById('trafficChart')) return;
        try {
            const resp = await fetch(`/api/traffic-stats?${getFilterParams()}`);
            const data = await resp.json();
            ChartUtils.createMultiChart('trafficChart', data.labels, [
                { label: 'P≈ô√≠chody', data: data.joins },
                { label: 'Odchody', data: data.leaves }
            ]);
        } catch (e) { }
    }

    async function loadCommandStats() {
        if (!document.getElementById('commandChart')) return;
        try {
            const resp = await fetch(`/api/command-stats?${getFilterParams()}`);
            const data = await resp.json();
            const labels = data.map(d => d.name);
            const counts = data.map(d => d.count);
            ChartUtils.createBarChart('commandChart', labels, counts, 'Pou≈æit√≠', '#3b82f6', '#06b6d4');
        } catch (e) { }
    }

    async function loadVoiceStats() {
        const tbody = document.getElementById('voice-tbody');
        if (!tbody) return;
        try {
            const resp = await fetch(`/api/voice-stats?${getFilterParams()}`);
            const data = await resp.json();

            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 15px;">≈Ω√°dn√° data.</td></tr>';
                return;
            }
            data.forEach(u => {
                const hours = Math.floor(u.duration_seconds / 3600);
                const mins = Math.floor((u.duration_seconds % 3600) / 60);
                tbody.innerHTML += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05)">
                    <td style="padding: 10px;">User ${u.user_id}</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600;">${hours}h ${mins}m</td>
                </tr>`;
            });
        } catch (e) { }
    }

    document.addEventListener('DOMContentLoaded', () => {
        {% if layout.get('show_comparisons', True) %} loadComparisons(); {% endif %}
        {% if layout.get('show_top_channels', True) %} loadChannelStats(); {% endif %}
        {% if layout.get('show_leaderboard', True) %} loadLeaderboard(); {% endif %}
        {% if layout.get('show_peak_analysis', True) %} loadPeakAnalysis(); {% endif %}
        {% if layout.get('show_tools', True) %} loadAnalyticsTools(); {% endif %}
        {% if layout.get('show_traffic', True) %} loadTrafficStats(); {% endif %}
        {% if layout.get('show_commands', True) %} loadCommandStats(); {% endif %}
        {% if layout.get('show_voice', True) %} loadVoiceStats(); {% endif %}
        {% if layout.get('show_channel_dist', True) %} loadChannelDist(); {% endif %}
    });
</script>
{% endblock %}