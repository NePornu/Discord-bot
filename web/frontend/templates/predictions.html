{% extends "base.html" %}

{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div>
        <h1 class="title">ğŸ”® Predikce</h1>
        <p style="color: var(--text-secondary);">Odhad budoucÃ­ho vÃ½voje na zÃ¡kladÄ› historickÃ½ch dat serveru.</p>
    </div>

    <div style="display: flex; gap: 16px; align-items: center;">
        <button id="editLayoutBtn" onclick="toggleEditMode()" class="btn"
            style="padding: 6px 12px; white-space: nowrap; display: flex; align-items: center; gap: 8px; background: var(--bg-card);">
            ğŸ–Šï¸ Upravit rozloÅ¾enÃ­
        </button>
        <button id="saveLayoutBtn" onclick="saveLayout()" class="btn"
            style="padding: 6px 12px; white-space: nowrap; display: none; align-items: center; gap: 8px; background: var(--success-gradient); color: white;">
            ğŸ’¾ UloÅ¾it
        </button>
    </div>
</div>


<div id="hidden-drawer" class="hidden-drawer"
    style="display: none; margin-bottom: 30px; background: var(--bg-secondary); padding: 20px; border-radius: 16px; border: 2px dashed var(--glass-border);">
    <h3 style="margin-bottom: 15px; color: var(--text-secondary);">SkrytÃ© moduly (pÅ™etÃ¡hnÄ›te zpÄ›t pro zobrazenÃ­)</h3>
    <div id="hidden-widgets-grid" class="grid">

    </div>
</div>


{% macro render_widget(id) %}
{% if id == 'card_pred_members' %}
<div class="card" data-id="card_pred_members">
    <h3 style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">OÄekÃ¡vanÃ½ poÄet ÄlenÅ¯ za 30 dnÃ­
    </h3>
    <div class="stat-value" id="pred-members">--</div>
    <div class="stat-diff" id="pred-members-diff">PoÄÃ­tÃ¡m...</div>
    <div
        style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px; border-top: 1px solid var(--glass-border); padding-top: 8px;">
        ğŸ“Š PrÅ¯mÄ›rnÃ½ mÄ›sÃ­ÄnÃ­ rÅ¯st: <strong id="avg-growth">--</strong> ÄlenÅ¯ | AktuÃ¡lnÄ›: <strong
            id="current-members">--</strong>
    </div>
</div>
{% elif id == 'card_pred_msgs' %}
<div class="card" data-id="card_pred_msgs">
    <h3 style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Odhad zprÃ¡v (ZÃ­tra)</h3>
    <div class="stat-value" id="pred-msgs">--</div>
    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">dle 30dennÃ­ho trendu a sezÃ³nnosti
    </div>
</div>
{% elif id == 'chart_main_pred' %}
<div class="card" data-id="chart_main_pred" style="min-height: 350px;">
    <h3 style="margin-bottom: 16px;">ğŸ“ˆ VÃ½hled: RÅ¯st ÄlenÅ¯ (6 mÄ›sÃ­cÅ¯)</h3>
    <div style="height: 300px;"><canvas id="predictionChart"></canvas></div>
</div>
{% elif id == 'chart_activity_forecast' %}
<div class="card" data-id="chart_activity_forecast">
    <h3 style="margin-bottom: 16px;">ğŸ“… Predikce aktivity (7 dnÃ­)</h3>
    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">OÄekÃ¡vanÃ½ objem zprÃ¡v.</p>
    <div style="height: 220px;"><canvas id="activityForecastChart"></canvas></div>
</div>
{% elif id == 'chart_dau_pred' %}
<div class="card" data-id="chart_dau_pred">
    <h3 style="margin-bottom: 16px;">ğŸ‘¤ Predikce DAU (7 dnÃ­)</h3>
    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">DennÄ› aktivnÃ­ uÅ¾ivatelÃ©. Trend:
        <strong id="dau-trend">--</strong>
    </p>
    <div style="height: 220px;"><canvas id="dauChart"></canvas></div>
</div>
{% elif id == 'widget_mau' %}
<div class="card" data-id="widget_mau">
    <h3 style="margin-bottom: 16px;">ğŸ“Š Predikce MAU (3 mÄ›sÃ­ce)</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="mau-value">--</div>
            <div style="font-size: 12px; color: var(--text-secondary);">MAU (tento mÄ›sÃ­c)</div>
        </div>
        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="stickiness-value">--%</div>
            <div style="font-size: 12px; color: var(--text-secondary);">DAU/MAU Ratio</div>
        </div>
    </div>
    <div style="height: 180px;"><canvas id="mauChart"></canvas></div>
</div>
{% elif id == 'widget_stability' %}
<div class="card" data-id="widget_stability">
    <h3 style="margin-bottom: 16px;">ğŸš¦ Predikce stability</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="churn-risk-val">--%</div>
            <div style="font-size: 12px; color: var(--text-secondary);">SkÃ³re stability</div>
        </div>
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700;" id="leaves-3m">--</div>
            <div style="font-size: 12px; color: var(--text-secondary);">OdchodÅ¯ (3 mÄ›sÃ­ce)</div>
        </div>
    </div>
    <div id="risk-details" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
        <div style="font-weight: 600; margin-bottom: 8px;" id="risk-title">ğŸ“Š AnalÃ½za</div>
        <p id="risk-explanation" style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
            NaÄÃ­tÃ¡m data...</p>
    </div>
</div>
{% elif id == 'chart_peak' %}
<div class="card" data-id="chart_peak">
    <h3 style="margin-bottom: 16px;">â° Predikce vrcholovÃ½ch hodin</h3>
    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Kdy oÄekÃ¡vat nejvyÅ¡Å¡Ã­ aktivitu
        zÃ­tra.</p>
    <div style="height: 200px;"><canvas id="peakHoursChart"></canvas></div>
</div>
{% elif id == 'chart_seasonal' %}
<div class="card" data-id="chart_seasonal">
    <h3 style="margin-bottom: 16px;">ğŸ“† SezÃ³nnÃ­ predikce</h3>
    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">OÄekÃ¡vanÃ¡ aktivita podle dne v
        tÃ½dnu.</p>
    <div style="height: 200px;"><canvas id="seasonalChart"></canvas></div>
</div>
{% elif id == 'chart_engagement' %}
<div class="card" data-id="chart_engagement">
    <h3 style="margin-bottom: 16px;">ğŸ’¬ Predikce engagementu</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 700; color: #8b5cf6;" id="eng-current">--</div>
            <div style="font-size: 11px; color: var(--text-secondary);">AktuÃ¡lnÃ­</div>
        </div>
        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 700; color: #ec4899;" id="eng-predicted">--</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Za 7 dnÃ­</div>
        </div>
    </div>
    <div style="height: 140px;"><canvas id="engagementChart"></canvas></div>
</div>
{% elif id == 'chart_new_returning' %}
<div class="card" data-id="chart_new_returning">
    <h3 style="margin-bottom: 16px;">ğŸ‘¥ Predikce: NovÃ­ vs VracejÃ­cÃ­</h3>
    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">OÄekÃ¡vanÃ½ pomÄ›r.</p>
    <div style="height: 200px;"><canvas id="newVsReturningChart"></canvas></div>
</div>
{% elif id == 'chart_voice' %}
<div class="card" data-id="chart_voice">
    <h3 style="margin-bottom: 16px;">ğŸ¤ Predikce voice aktivity</h3>
    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">OÄekÃ¡vanÃ© minuty (7 dnÃ­).</p>
    <div style="height: 200px;"><canvas id="voiceChart"></canvas></div>
</div>
{% elif id == 'chart_channels' %}
<div class="card" data-id="chart_channels">
    <h3 style="margin-bottom: 16px;">ğŸ“Š Predikce top kanÃ¡lÅ¯</h3>
    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">OÄekÃ¡vanÃ¡ aktivita (zÃ­tra).</p>
    <div style="height: 200px;"><canvas id="channelsChart"></canvas></div>
</div>
{% endif %}
{% endmacro %}

{% set default_order = ['card_pred_members', 'card_pred_msgs', 'chart_main_pred', 'chart_activity_forecast',
'chart_dau_pred', 'widget_mau', 'widget_stability', 'chart_peak', 'chart_seasonal', 'chart_engagement',
'chart_new_returning', 'chart_voice', 'chart_channels'] %}
{% set active_order = widget_order if widget_order else default_order %}


{% set hidden_widgets = [] %}
{% for def_id in default_order %}
{% if def_id not in active_order %}
{% set _ = hidden_widgets.append(def_id) %}
{% endif %}
{% endfor %}


{% set saved_spans = request.session.get('dashboard_spans', {}) %}
<div id="predictions-grid" class="grid">
    {% for widget_id in active_order %}

    {% set default_span = 1 %}
    {% if widget_id in ['chart_main_pred', 'chart_activity_forecast', 'chart_dau_pred', 'widget_mau',
    'widget_stability'] %}{% set default_span = 2 %}{% endif %}
    {% set span_val = saved_spans.get(widget_id, default_span) %}

    <div class="widget-wrapper span-{{span_val}}" data-id="{{widget_id}}" data-span="{{span_val}}"
        style="position: relative; display: flex; flex-direction: column;">


        <div class="resize-controls"
            style="display: none; position: absolute; top: 8px; right: 8px; z-index: 100; gap: 4px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
            <button class="resize-btn action-decrease" title="ZÃºÅ¾it"
                style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5" />
                </svg>
            </button>
            <button class="resize-btn action-increase" title="RozÅ¡Ã­Å™it"
                style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 17l5-5-5-5M6 17l5-5-5-5" />
                </svg>
            </button>
        </div>


        <style>
            .widget-wrapper .card {
                height: 100% !important;
                margin: 0 !important;
            }
        </style>
        {{render_widget(widget_id)}}
    </div>
    {% endfor %}
</div>


<div style="display:none;">
    <div id="hidden-bucket">
        {% for widget_id in hidden_widgets %}

        {% set default_span = 1 %}
        {% if widget_id in ['chart_main_pred', 'chart_activity_forecast', 'chart_dau_pred', 'widget_mau',
        'widget_stability', 'chart_voice', 'chart_channels'] %}{% set default_span = 2 %}{% endif %}
        {% set span_val = saved_spans.get(widget_id, default_span) %}

        <div class="widget-wrapper span-{{span_val}}" data-id="{{widget_id}}" data-span="{{span_val}}"
            style="position: relative; display: flex; flex-direction: column;">


            <div class="resize-controls"
                style="display: none; position: absolute; top: 8px; right: 8px; z-index: 100; gap: 4px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(8px);">
                <button class="resize-btn action-decrease" title="ZÃºÅ¾it"
                    style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 17l-5-5 5-5M18 17l-5-5 5-5" />
                    </svg>
                </button>
                <button class="resize-btn action-increase" title="RozÅ¡Ã­Å™it"
                    style="width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 6px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 17l5-5-5-5M6 17l5-5-5-5" />
                    </svg>
                </button>
            </div>


            <style>
                .widget-wrapper .card {
                    height: 100% !important;
                    margin: 0 !important;
                }
            </style>
            {{render_widget(widget_id)}}
        </div>
        {% endfor %}
    </div>
</div>
</div>

<style>
    .sortable-ghost {
        opacity: 0.4;
        background: var(--bg-tertiary);
        border: 2px dashed var(--primary);
    }

    .draggable-mode .card {
        cursor: grab;
        border: 2px dashed rgba(255, 255, 255, 0.1);
    }

    .draggable-mode .card:hover {
        border-color: var(--primary);
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    // --- Sortable Implementation ---
    let sortableMain = null;
    let sortableHidden = null;
    const grid = document.getElementById('predictions-grid');
    const drawer = document.getElementById('hidden-drawer');
    const hiddenGrid = document.getElementById('hidden-widgets-grid');
    const editBtn = document.getElementById('editLayoutBtn');
    const saveBtn = document.getElementById('saveLayoutBtn');

    // Move hidden widgets to drawer on load
    document.addEventListener('DOMContentLoaded', () => {
        const bucket = document.getElementById('hidden-bucket');
        while (bucket.children.length > 0) {
            hiddenGrid.appendChild(bucket.children[0]);
        }
    });

    function toggleEditMode() {
        if (sortableMain) {
            // Cancel/Exit
            sortableMain.destroy();
            sortableHidden.destroy();
            sortableMain = null;
            sortableHidden = null;

            editBtn.innerHTML = 'ğŸ–Šï¸ Upravit rozloÅ¾enÃ­';
            editBtn.classList.remove('btn-active');
            editBtn.style.background = '';
            saveBtn.style.display = 'none';
            drawer.style.display = 'none';
            grid.classList.remove('draggable-mode');
            hiddenGrid.classList.remove('draggable-mode');

            // Hide Controls explicitly
            document.querySelectorAll('.resize-controls').forEach(el => el.style.display = 'none');

            window.location.reload();
        } else {
            // Enable
            drawer.style.display = 'block';
            grid.classList.add('draggable-mode');
            hiddenGrid.classList.add('draggable-mode');

            // Show Controls explicitly
            document.querySelectorAll('.resize-controls').forEach(el => el.style.display = 'flex');

            sortableMain = new Sortable(grid, {
                group: 'predictions',
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.card'
            });

            sortableHidden = new Sortable(hiddenGrid, {
                group: 'predictions',
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.card'
            });

            editBtn.innerHTML = 'âŒ ZruÅ¡it';
            editBtn.style.background = 'var(--bg-tertiary)';
            saveBtn.style.display = 'flex';
        }
    }

    // --- Robust Resize Logic (Capture Phase Delegation) ---
    grid.addEventListener('mousedown', (e) => {
        if (e.target.closest('.resize-controls')) e.stopPropagation();
    }, { capture: true });

    grid.addEventListener('touchstart', (e) => {
        if (e.target.closest('.resize-controls')) e.stopPropagation();
    }, { capture: true });

    grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.resize-btn');
        if (!btn) return;
        e.preventDefault(); e.stopPropagation();

        const wrapper = btn.closest('.widget-wrapper');
        const isIncrease = btn.classList.contains('action-increase');
        const delta = isIncrease ? 1 : -1;

        if (wrapper) {
            let currentSpan = parseInt(wrapper.dataset.span || 1);
            let newSpan = Math.max(1, Math.min(4, currentSpan + delta));

            wrapper.classList.remove('span-1', 'span-2', 'span-3', 'span-4');
            wrapper.classList.add(`span-${newSpan}`);
            wrapper.dataset.span = newSpan;
            wrapper.style.gridColumn = `span ${newSpan}`;

            wrapper.style.transform = 'scale(1.02)';
            wrapper.style.boxShadow = '0 0 20px var(--accent)';
            setTimeout(() => { wrapper.style.transform = ''; wrapper.style.boxShadow = ''; }, 200);
        }
    });

    async function saveLayout() {
        if (!sortableMain) return;
        const wrappers = document.querySelectorAll('#predictions-grid .widget-wrapper');
        const visibleOrder = [];
        const spans = {};

        wrappers.forEach(w => {
            const id = w.dataset.id;
            visibleOrder.push(id);
            spans[id] = parseInt(w.dataset.span || 1);
        });

        const formData = new FormData();
        formData.append('widget_order', JSON.stringify(visibleOrder));
        formData.append('widget_spans', JSON.stringify(spans));
        formData.append('page', 'predictions');

        try {
            const resp = await fetch('/settings/dashboard', {
                method: 'POST',
                body: formData
            });
            if (resp.ok) {
                window.location.reload();
            } else {
                alert('Chyba pÅ™i uklÃ¡dÃ¡nÃ­ rozloÅ¾enÃ­');
            }
        } catch (e) {
            console.error(e);
            alert('Chyba spojenÃ­');
        }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const resp = await fetch('/api/predictions-data');
            const data = await resp.json();

            // Populate Cards (Check if element exists first!)
            const safeSetText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

            safeSetText('pred-members', data.predictions.members_30d);

            const diffEl = document.getElementById('pred-members-diff');
            if (diffEl) {
                diffEl.textContent = ((data.predictions.members_growth_pct > 0 ? '+' : '') + data.predictions.members_growth_pct + '%');
                diffEl.className = 'stat-diff ' + (data.predictions.members_growth_pct >= 0 ? 'diff-positive' : 'diff-negative');
            }

            safeSetText('avg-growth', data.predictions.avg_monthly_growth || 0);
            safeSetText('current-members', data.predictions.current_members || '--');
            safeSetText('pred-msgs', data.predictions.expected_msgs_tomorrow);

            // Chart initializers check for element existence inside
            if (document.getElementById('predictionChart')) {
                new Chart(document.getElementById('predictionChart'), {
                    type: 'line',
                    data: {
                        labels: [...data.history.dates, ...data.forecast.dates],
                        datasets: [
                            { label: 'Historie', data: [...data.history.members, ...Array(data.forecast.dates.length).fill(null)], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 },
                            { label: 'Predikce', data: [...Array(data.history.dates.length - 1).fill(null), data.history.members[data.history.members.length - 1], ...data.forecast.members], borderColor: '#ec4899', borderDash: [5, 5], backgroundColor: 'rgba(236, 72, 153, 0.05)', fill: true, tension: 0.4 }
                        ]
                    },
                    options: {
                        interaction: { intersect: false, mode: 'index' },
                        plugins: { legend: { display: true } }
                    }
                });
            }

            if (document.getElementById('activityForecastChart')) {
                new Chart(document.getElementById('activityForecastChart'), {
                    type: 'bar',
                    data: { labels: data.forecast.days, datasets: [{ label: 'OÄekÃ¡vanÃ© zprÃ¡vy', data: data.forecast.activity, backgroundColor: data.forecast.activity.map((v, i) => i === 0 ? '#10b981' : 'rgba(139, 92, 246, 0.5)'), borderRadius: 4 }] },
                    options: { plugins: { legend: { display: false } } }
                });
            }

            if (document.getElementById('dauChart') && data.dau) {
                safeSetText('dau-trend', data.dau.trend === 'up' ? 'ğŸ“ˆ RostoucÃ­' : data.dau.trend === 'down' ? 'ğŸ“‰ KlesajÃ­cÃ­' : 'â¡ï¸ StabilnÃ­');
                new Chart(document.getElementById('dauChart'), {
                    type: 'line',
                    data: { labels: [...data.dau.history_labels, ...data.dau.forecast_labels], datasets: [{ label: 'Historie', data: [...data.dau.history, ...Array(data.dau.forecast.length).fill(null)], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }, { label: 'Predikce', data: [...Array(data.dau.history.length - 1).fill(null), data.dau.history[data.dau.history.length - 1], ...data.dau.forecast], borderColor: '#ec4899', borderDash: [5, 5], backgroundColor: 'rgba(236, 72, 153, 0.05)', fill: true, tension: 0.4 }] },
                    options: {
                        interaction: { intersect: false, mode: 'index' },
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: { x: { display: false } }
                    }
                });
            }

            if (document.getElementById('mauChart') && data.mau) {
                safeSetText('mau-value', data.mau.current);
                safeSetText('stickiness-value', data.mau.dau_mau_ratio + '%');
                new Chart(document.getElementById('mauChart'), {
                    type: 'bar',
                    data: { labels: ['NynÃ­', '+1 mÄ›sÃ­c', '+2 mÄ›sÃ­ce', '+3 mÄ›sÃ­ce'], datasets: [{ label: 'MAU Predikce', data: data.mau.forecast, backgroundColor: ['#3b82f6', 'rgba(59,130,246,0.7)', 'rgba(59,130,246,0.5)', 'rgba(59,130,246,0.3)'], borderRadius: 4 }] },
                    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            // Peak Hours
            if (document.getElementById('peakHoursChart')) {
                const hourlyPrediction = [];
                for (let h = 0; h < 24; h++) {
                    let base = data.predictions.expected_msgs_tomorrow / 24;
                    if (h >= 18 && h <= 22) base *= 2.5; else if (h >= 14 && h <= 17) base *= 1.5; else if (h >= 3 && h <= 8) base *= 0.2;
                    hourlyPrediction.push(Math.round(base));
                }
                new Chart(document.getElementById('peakHoursChart'), { type: 'line', data: { labels: Array.from({ length: 24 }, (_, i) => `${i}:00`), datasets: [{ label: 'Predikce', data: hourlyPrediction, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4 }] }, options: { plugins: { legend: { display: false } }, scales: { x: { display: false } } } });
            }

            // Seasonal
            if (document.getElementById('seasonalChart') && data.forecast.activity) {
                new Chart(document.getElementById('seasonalChart'), {
                    type: 'radar',
                    data: { labels: data.forecast.days || ['Po', 'Ãšt', 'St', 'ÄŒt', 'PÃ¡', 'So', 'Ne'], datasets: [{ label: 'Aktivita', data: data.forecast.activity, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.2)' }] },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: {
                            r: {
                                ticks: { showLabelBackdrop: false, color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                pointLabels: { color: '#9ca3af' }
                            }
                        }
                    }
                });
            }

            // Engagement
            if (document.getElementById('engagementChart')) {
                const currentEng = data.dau ? Math.round(data.dau.avg / (data.mau?.current || 1) * 100) : 0;
                const predictedEng = data.dau?.forecast ? Math.round(data.dau.forecast.slice(-1)[0] / (data.mau?.forecast?.slice(-1)[0] || 1) * 100) : currentEng;
                safeSetText('eng-current', currentEng + '%');
                safeSetText('eng-predicted', predictedEng + '%');
                new Chart(document.getElementById('engagementChart'), { type: 'line', data: { labels: ['NynÃ­', '+1d', '+2d', '+3d', '+4d', '+5d', '+6d', '+7d'], datasets: [{ label: 'Engagement %', data: [currentEng, ...Array(7).fill(0).map((_, i) => currentEng + (predictedEng - currentEng) * (i + 1) / 7 | 0)], borderColor: '#ec4899', tension: 0.4 }] }, options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } } });
            }

            // New vs Returning
            if (document.getElementById('newVsReturningChart')) {
                const avgMonthlyGrowth = data.predictions.avg_monthly_growth || 5;
                const totalMembers = data.predictions.current_members || 500;
                new Chart(document.getElementById('newVsReturningChart'), { type: 'doughnut', data: { labels: ['VracejÃ­cÃ­ se', 'NovÃ­'], datasets: [{ data: [Math.round(totalMembers * 0.7), Math.round(avgMonthlyGrowth)], backgroundColor: ['#3b82f6', '#10b981'], borderWidth: 0 }] }, options: { plugins: { legend: { display: true, position: 'bottom' } }, cutout: '50%' } });
            }

            // Voice (Simplified)
            if (document.getElementById('voiceChart')) {
                const voicePred = data.forecast.activity.map(a => Math.round(a * 0.15));
                new Chart(document.getElementById('voiceChart'), { type: 'bar', data: { labels: data.forecast.days, datasets: [{ label: 'Minuty', data: voicePred, backgroundColor: '#10b981', borderRadius: 4 }] }, options: { plugins: { legend: { display: false } } } });
            }

            // Channels Prediction Chart
            if (document.getElementById('channelsChart') && data.channels && data.channels.length > 0) {
                const cLabels = data.channels.map(c => c.name);
                const cData = data.channels.map(c => c.count);

                ChartUtils.createBarChart(
                    'channelsChart',
                    cLabels,
                    cData,
                    'OÄekÃ¡vanÃ© zprÃ¡vy',
                    '#3b82f6',
                    '#6366f1'
                );
            } else if (document.getElementById('channelsChart')) {
                const container = document.getElementById('channelsChart').parentElement;
                container.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);"><div style="font-size:48px;margin-bottom:12px;">ğŸ“ˆ</div><p>Å½Ã¡dnÃ¡ data pro predikci kanÃ¡lÅ¯</p></div>';
            }

            // Risk Analysis
            const currentMembers = data.predictions.current_members || 500;
            const leaves3m = (data.history.leaves || []).slice(-3).reduce((a, b) => a + b, 0);
            let stability = 100;
            if (leaves3m > 0 && currentMembers > 0) {
                const churnPct = (leaves3m / currentMembers) * 100;
                stability = Math.max(0, Math.round(100 - (churnPct * 10)));
            }
            safeSetText('churn-risk-val', stability + '%');
            safeSetText('leaves-3m', leaves3m);
            const stabilityEl = document.getElementById('churn-risk-val');
            if (stabilityEl) stabilityEl.style.color = stability < 50 ? '#ef4444' : stability < 80 ? '#f59e0b' : '#10b981';

            const titleEl = document.getElementById('risk-title');
            const explEl = document.getElementById('risk-explanation');
            let explanation = `Za 3 mÄ›sÃ­ce odeÅ¡lo ${leaves3m} ÄlenÅ¯.`;
            if (titleEl && explEl) {
                titleEl.textContent = stability >= 90 ? 'âœ… VÃ½bornÃ¡ stabilita' : 'âš ï¸ Pozor na odchody';
                explEl.textContent = explanation;
            }
        } catch (e) {
            console.error("Prediction load error", e);
        }
    });
</script>
{% endblock %}